# 月次請求書業務 業務ガイドライン

## 目次

1. [業務概要](#業務概要)
2. [月末処理フロー（メインワークフロー）](#月末処理フロー)
3. [コンプライアンス対応フロー](#コンプライアンス対応フロー)
4. [エラー対応ガイド](#エラー対応ガイド)
5. [チェックリスト](#チェックリスト)

---
<br>

## 業務概要

### このシステムの目的

1. **業務効率化**: 請求書データを自動抽出し、手入力作業を削減
2. **二重払い防止**: 過去の請求書と照合し、重複支払いを検出
3. **コンプライアンス対応**: 処理履歴を記録し、監査証跡を確保

### 基本的な考え方

- **月中**: 受領した請求書PDFを`pdf/`フォルダに溜める
- **月末**: 一括処理してバリデーション・重複チェック
- **月初**: 外部委託先に送付、履歴保存、CSV出力で完了

---

<br>

## 月末処理フロー

### 📅 実施タイミング
**毎月25日～月末** （締め日に合わせて調整可）

### 📋 事前準備

#### 1. PDFファイルの配置確認

**確認事項**:
- ✅ `pdf/`フォルダに請求書PDFが格納されている
- ✅ ファイル名は識別可能な名前（例: `202602_ABC商事_請求書.pdf`）
- ✅ PDFが破損していない（開けることを確認）

#### 2. 前月データの確認
```bash
# 前月の履歴が保存されているか確認
ls -la history/2026/
```

---

### ステップ1: OCR処理の実行

#### コマンド実行
```bash
python3 main.py
```

#### 画面表示
```
==================================================================
  請求書OCR処理システム
==================================================================

処理モードを選択してください:
  1. 請求書OCR処理を実行
  2. 過去実績をCSVで出力

選択 (1/2): 
```

#### 操作
```
1 を入力 → Enter
```

#### 処理の流れ
システムが自動的に以下を実行します:

1. **OCR処理** (5-10分程度)
   - PDFからテキスト抽出
   - 12項目のデータを自動認識
   - `output/invoice_data.json`に保存

2. **バリデーション** (即座)
   - 必須6項目の存在チェック
   - データ型の正当性チェック
   - 結果を画面表示

3. **重複チェック** (1-2分)
   - 過去の請求書と照合
   - 同一請求書番号を検出（エラー）
   - 類似請求書を検出（アラート）

---

### ステップ2: 処理結果の確認

#### 画面出力例（正常ケース）

```
==================================================================
  【バリデーション結果サマリー】
==================================================================
  請求書: 良好 45件 / 要確認 2件 / 合計 47件
==================================================================

==================================================================
  【二重払い防止チェック結果サマリー】
==================================================================
  請求書: 正常 45件 / エラー 0件 / アラート 2件 / 合計 47件

  ⚠️ アラート: 2件の請求書で類似データが検出されました
     → 発行者名・請求日・請求金額が一致する履歴があります
     → 詳細は output/duplicate.errors.json を確認してください
==================================================================
```

#### 確認作業

##### ✅ **良好件数の確認**
- 処理した請求書の総数と一致しているか確認

##### ⚠️ **要確認件数の対応**
要確認が1件でもある場合:

1. **エラー内容を確認**

2. **原因の特定**
   - 必須項目が抽出できていない
   - 請求書のフォーマットが特殊
   - PDFの品質が低い（スキャン画像が不鮮明）

3. **対処方法**
   - **Option A**: PDFを再スキャン（高解像度で）
   - **Option B**: 手動でデータ入力（Excelなどで別管理）
   - **Option C**: 発行元に再発行依頼

##### **エラー（二重払い検出）の対応**

**エラーが1件でも出た場合は必ず上長に報告**

**エラー内容例**:
```json
{
  "errors": [
    {
      "ファイル名": "202602_ABC商事_請求書.pdf",
      "請求書番号": "INV-2024-001",
      "重複理由": "同一請求書番号が履歴に存在",
      "重複詳細": [
        {
          "請求書番号": "INV-2024-001",
          "請求日": "2024年1月31日",
          "履歴ファイル": "history/2026/202601_invoice.json"
        }
      ]
    }
  ]
}
```

**対処フロー**:
1. 📞 **即座に上長に報告**
2. 🔍 発行元に確認（再送か、新規請求か）
3. 📝 調査結果を記録
4. ✅ 確認後、必要に応じて再処理

##### **アラート（類似検出）の対応**

アラートは「念のための警告」です。以下を確認:

1. **請求書番号が異なるか確認**
   - 異なる → 正当な別請求（問題なし）
   - 同じ → エラーと同様に対処

2. **発行元に確認が必要か判断**
   - 月次定額サービス → 問題なし
   - 単発案件 → 念のため確認推奨

---

### ステップ3: 外部委託先への送付

#### 送付データの準備

##### 1. **処理済みJSONの確認**

##### 2. **Excel変換（オプション）**
委託先がExcel形式を希望する場合:

```bash
# CSVを一時出力
python3 main.py
# メニューで 2 を選択

# Excelで開いて保存
# csv/invoice_history_YYYYMMDD_HHMMSS.csv → Excel形式に変換
```

##### 3. **送付パッケージの作成**
```bash
# 送付用フォルダを作成
mkdir -p 送付/202602

# PDFをコピー
cp pdf/*.pdf 送付/202602/

# JSONをコピー
cp output/invoice_data.json 送付/202602/

# Excel（任意）
cp <変換したExcel> 送付/202602/請求書一覧_202602.xlsx
```

#### 送付メールのテンプレート

```
件名: 【202X年XX月分】請求書データ送付

〇〇株式会社
ご担当者様

お世話になっております。

202X年XX月分の請求書データを送付いたします。

【送付内容】
・請求書PDF: XX件
・処理済みJSONデータ: 1ファイル
・請求書一覧（Excel）: 1ファイル

お手数ですが、ご確認のほどよろしくお願いいたします。

---
署名
```

---

### ステップ4: 履歴の保存（重要）

**この作業を忘れると次回の重複チェックが機能しません**

#### 履歴保存の手順

```bash
# 1. 年月フォルダの作成
mkdir -p history/2026

# 2. JSONを履歴に保存（ファイル名を年月形式に）
cp output/invoice_data.json history/2026/202602_invoice.json

# 3. 保存確認
ls -lh history/2026/202602_invoice.json
```

#### 保存ルール

- **ファイル名形式**: `YYYYMM_invoice.json`
- **保存場所**: `history/YYYY/`
- **保管期限**: 7年間（税法に準拠）

#### 保存後の確認

```
history/
├── 2024/
│   ├── 202401_invoice.json
│   └── 202412_invoice.json
├── 2025/
│   └── 202512_invoice.json
└── 2026/
    ├── 202601_invoice.json
    └── 202602_invoice.json  ← 今月分が追加されている
```

---
<br>

## コンプライアンス対応フロー

### 実施タイミング
**月次処理完了後**

### 目的
- 処理履歴の可視化
- 監査証跡の提出
- データ完全性の確認

---

### ステップ1: CSV出力の実行

#### コマンド実行
```bash
python3 main.py
```

#### 操作
```
処理モードを選択してください:
  1. 請求書OCR処理を実行
  2. 過去実績をCSVで出力

選択 (1/2): 2 ← ここで 2 を入力
```

#### 処理内容
- `history/`フォルダ内の全JSONを読み込み
- 時系列でソート
- CSV形式で出力（`csv/invoice_history_YYYYMMDD_HHMMSS.csv`）

---

### ステップ2: 出力結果の確認

#### 画面出力例
```
==================================================================
  【過去実績エクスポート完了】
==================================================================
  ✓ CSVファイル: invoice_history_20260207_153022.csv
  ✓ 総レコード数: 234件
  ✓ 出力先: csv/invoice_history_20260207_153022.csv
==================================================================
```

#### 確認項目

##### 1. **レコード数の妥当性**
```bash
# CSVの行数を確認（ヘッダー含む）
wc -l csv/invoice_history_*.csv
```

- 過去の処理件数と一致しているか
- 欠損がないか

##### 2. **データの完全性**
```bash
# Excelで開いて目視確認
open csv/invoice_history_*.csv
```

**確認ポイント**:
- ✅ 処理日時が時系列順に並んでいる
- ✅ 必須項目が埋まっている
- ✅ 文字化けがない

---

<br>

## エラー対応ガイド

### エラーレベルの定義

| レベル | 種別 | 対応優先度 | 報告義務 |
|--------|------|-----------|---------|
| 🔴 **エラー** | 二重払い検出 | **即対応** | **必須** |
| 🟡 **アラート** | 類似検出 | 確認推奨 | 任意 |
| 🔵 **要確認** | データ抽出失敗 | 手動補完 | 件数報告 |

---

### 🔴 エラー対応フロー

#### パターン1: 同一請求書の再送

**症状**:
```
⚠️ エラー: 1件の請求書で同一請求書番号が検出されました
請求書番号: INV-2024-001
```

**原因**: 既に支払い済みの請求書が再送された

**対処**:
1. 発行元に確認
   - 「請求書番号 INV-2024-001 は既に受領済みですが、再送でしょうか？」
2. 再送の場合 → 支払い不要（PDFを削除）
3. 別請求の場合 → 請求書番号の修正を依頼

#### パターン2: 請求書番号の重複

**症状**:
```
⚠️ エラー: 2件の請求書で同一請求書番号が検出されました
```

**原因**: 異なる案件で同じ請求書番号を使用

**対処**:
1. 両方のPDFを目視確認
2. 内容が異なる場合 → 発行元に番号の修正を依頼
3. 同一内容の場合 → 重複受領（片方削除）

---

### 🟡 アラート対応フロー

#### パターン1: 月次定額サービス

**症状**:
```
⚠️ アラート: 発行者名・請求日・請求金額が一致
発行者: ABC株式会社
請求日: 2026年2月28日
金額: ¥100,000
```

**確認**:
- 月額固定のサービスか？ → **問題なし**
- 請求書番号が異なるか？ → **問題なし**

**記録**:
```
確認日: 2026/02/07
確認者: 山田太郎
結果: 月次定額サービスのため正常
```

#### パターン2: 同一案件の分割請求

**症状**: 同じ発行者から同日に複数請求

**確認**:
- 契約書で分割請求が規定されているか
- 合計金額が契約金額と一致するか

**対処**:
- 問題なし → 記録のみ
- 不明 → 発行元に確認

---

### 🔵 要確認データ対応フロー

#### パターン1: PDFスキャン品質要確認

**症状**:
```
要確認: 2件
バリデーションエラー: 必須項目 '請求書番号' が不足しています
```

**対処**:
1. PDFを開いて目視確認
2. 画質が悪い → **再スキャン依頼**
3. 手書き請求書 → **手動入力**

**手動入力の手順**:
```bash
# output/invoice_data.json を直接編集
vim output/invoice_data.json

# または Excel で管理
```

#### パターン2: 非標準フォーマット

**症状**: 海外企業の英文請求書で項目が抽出できない

**対処**:
1. `config/fields.yaml`のパターン追加（要技術者）
2. 手動入力で暫定対応

---

<br>

## チェックリスト

### 📋 月末処理チェックリスト

```
□ 【準備】PDFファイルを pdf/ フォルダに配置
□ 【準備】前月の履歴が history/ に保存されているか確認

□ 【処理】python3 main.py を実行（メニュー1）
□ 【確認】バリデーション結果を確認
    □ 良好件数: _____ 件
    □ 要確認件数: _____ 件（0件が望ましい）

□ 【確認】重複チェック結果を確認
    □ エラー件数: _____ 件（0件必須）
    □ アラート件数: _____ 件
    □ エラーがある場合 → 上長に報告済み □

□ 【対応】要確認データの処理
    □ 再スキャン完了 □
    □ 手動入力完了 □
    □ 発行元に確認済み □

□ 【送付】外部委託先への送付完了
    □ PDF一式
    □ invoice_data.json
    □ Excel一覧（任意）

□ 【保存】履歴の保存（重要！）
    □ history/YYYY/YYYYMM_invoice.json に保存完了

□ 【CSV】コンプライアンス対応（メニュー2）
    □ CSV出力完了
    □ 共有フォルダに格納完了

実施日: ______年____月____日
実施者: __________________ 印
確認者: __________________ 印
```

---
<br>

## 改訂履歴

| バージョン | 日付 | 変更内容 | 承認者 |
|-----------|------|---------|-------|
| 1.0 | 2026/02/07 | 初版作成 | - |

